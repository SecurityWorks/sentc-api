base_mw: "middleware"
handler_404: crate::not_found_handler
prefix: "/api"
routes:
  # api v1 routes
  - group:
      p: "/v1"
      gr:
        #_______________________________________________________________________________________________________________
        # customer register routes, don't need any mw
        - post: {p: "/customer/register", s: crate::customer::register}
        - get: {p: "/customer/register/:email_key", s: crate::customer::done_register}

        #_______________________________________________________________________________________________________________
        # customer routes are called form the dashboard
        # TODO check customer jwt, with extra mw (to check the aud and the app id, app id must be the internal sentc id)
        - group:
            p: "/customer"
            gr:
              - post: { p: "/app", s: crate::customer_app::create_app }
              - group:
                  p: "/app/:app_id"
                  gr:
                    - put: {p: "", s: crate::customer_app::update}
                    - delete: {p: "", s: crate::customer_app::delete}
                    - patch: {p: "/token_renew", s: crate::customer_app::renew_tokens}
                    # jwt keys
                    - patch: {p: "/new_jwt_keys", s: crate::customer_app::add_jwt_keys}
                    - get: {p: "/jwt", s: crate::customer_app::get_jwt_details}
                    - delete: {p: "/jwt/:jwt_id", s: crate::customer_app::delete_jwt_keys}
        #_______________________________________________________________________________________________________________
        # routes don't need jwt check, but an app token
        - group:
            p: ""
            mw:
              - app_token::app_token_transform
            gr:
              - post: {p: "/exists", s: crate::user::exists}
              - post: {p: "/register", s: crate::user::register}
              - post: {p: "/prepare_login", s: crate::user::prepare_login}
              - post: {p: "/done_login", s: crate::user::done_login}
        #_______________________________________________________________________________________________________________
        # routes which needed jwt check with a valid jwt
        - group:
            p: ""
            mw:
              - jwt::jwt_transform
            gr:
              #_________________________________________________________________________________________________________
              # user routes in the user mod
              - group:
                  p: "/user"
                  gr:
                    - get: {p: "", s: crate::user::get}
                    - put: {p: "", s: crate::user::update}
                    - put: {p: "/update_pw", s: crate::user::change_password}
                    - put: {p: "/reset_pw", s: crate::user::reset_password}
                    # check the api token for delete action, maybe the app creator only wants to trigger delete from the own backend
                    - delete:
                        p: ""
                        s: crate::user::delete
                        mw:
                          - app_token::app_token_transform
              #_________________________________________________________________________________________________________
              # group routes in the group mod, check always the app token for this actions
              - group:
                  p: "/group"
                  mw:
                    - app_token::app_token_transform
                  gr:
                    - post: {p: "", s: crate::group::create}
                    - group:
                        p: "/:group_id"
                        gr:
                          - delete: {p: "", s: crate::group::delete}
              #_________________________________________________________________________________________________________
              # group routes without the app token check
              - group:
                  p: "/group"
                  gr:
                    - group:
                        p: "/:group_id"
                        gr:
                          - get: { p: "", s: crate::group::get }