base_mw: "middleware"
handler_404: crate::not_found_handler
prefix: "/api"
routes:
  # api v1 routes
  - group:
      p: "/v1"
      gr:
        #_______________________________________________________________________________________________________________
        # customer
        - group:
            p: "/customer"
            mw:
              - app_token::app_token_base_app_transform
            gr:
              - post: {p: "/register", s: crate::customer::register}
              - post: {p: "/prepare_login", s: crate::customer::prepare_login}
              - post: {p: "/done_login", s: crate::customer::done_login}
              - put: {p: "/password_reset", s: crate::customer::prepare_reset_password}
              - put: {p: "/password_reset_validation", s: crate::customer::done_reset_password}
        #_______________________________________________________________________________________________________________
        # customer routes with the jwt check, but no app check because the jwt got already the app reference,
        # and we are only using public token for dashboard routes
        - group:
            p: "/customer"
            mw:
              - jwt::jwt_app_check_transform
            gr:
              # customer must be logged in, in the dashboard when sending this req
              - get: {p: "/register/:email_key", s: crate::customer::done_register}
              - patch: {p: "/email_resend", s: crate::customer::resend_email}
              - put: {p: "", s: crate::customer::update}
              - put: {p: "/password", s: crate::customer::change_password}
              - delete: {p: "", s: crate::customer::delete}

              - get: {p: "/apps/:last_fetched_time/:last_app_id", s: crate::customer::get_all_apps}
              # ________________________________________________________________________________________________________
              # App routes
              - post: { p: "/app", s: crate::customer_app::create_app }
              - group:
                  p: "/app/:app_id"
                  gr:
                    - put: { p: "", s: crate::customer_app::update }
                    - delete: { p: "", s: crate::customer_app::delete }
                    - patch: { p: "/token_renew", s: crate::customer_app::renew_tokens }
                    # jwt keys
                    - patch: { p: "/new_jwt_keys", s: crate::customer_app::add_jwt_keys }
                    - get: { p: "/jwt", s: crate::customer_app::get_jwt_details }
                    - delete: { p: "/jwt/:jwt_id", s: crate::customer_app::delete_jwt_keys }
        #_______________________________________________________________________________________________________________
        # routes don't need jwt check, but an app token
        - group:
            p: ""
            mw:
              - app_token::app_token_transform
            gr:
              - post: {p: "/exists", s: crate::user::exists}
              - post: {p: "/register", s: crate::user::register}
              - post: {p: "/prepare_login", s: crate::user::prepare_login}
              - post: {p: "/done_login", s: crate::user::done_login}
        #_______________________________________________________________________________________________________________
        # routes which needed jwt check with a valid jwt
        - group:
            p: ""
            mw:
              - jwt::jwt_transform
              - app_token::app_token_transform
            gr:
              #_________________________________________________________________________________________________________
              # user routes in the user mod
              - group:
                  p: "/user"
                  gr:
                    - get: {p: "", s: crate::user::get}
                    - put: {p: "", s: crate::user::update}
                    - put: {p: "/update_pw", s: crate::user::change_password}
                    - put: {p: "/reset_pw", s: crate::user::reset_password}
                    # check the api token for delete action, maybe the app creator only wants to trigger delete from the own backend
                    - delete: {p: "", s: crate::user::delete}
              #_________________________________________________________________________________________________________
              # group routes in the group mod, check always the app token for this actions
              - group:
                  p: "/group"
                  gr:
                    #___________________________________________________________________________________________________
                    # no group mw check needed here
                    - post: {p: "", s: crate::group::create}
                    # no group mw for get invite req, because this is called form the user, not the group
                    - get: {p: "/invite/:last_fetched_time/:last_group_id", s: crate::group::get_invite_req}
                    - group:
                        p: "/:group_id"
                        gr:
                          - patch: { p: "/invite", s: crate::group::accept_invite }
                          - delete: { p: "/invite", s: crate::group::reject_invite }
                          - patch: {p: "/join_req", s: crate::group::join_req}
                    #___________________________________________________________________________________________________
                    # group mw check needed here
                    - group:
                        p: "/:group_id"
                        mw:
                          - group::group_transform
                        gr:
                          - get: { p: "", s: crate::group::get_user_group_data }
                          - get: { p: "/keys/:last_fetched_time/:last_k_id", s: crate::group::get_user_group_keys }
                          - post: {p: "/child", s: crate::group::create_child_group}
                          - delete: {p: "", s: crate::group::delete}
                          - delete: {p: "/leave", s: crate::group::leave_group}
                          - put: {p: "/invite/:invited_user", s: crate::group::invite_request}
                          - put: {p: "/invite/session/:key_session_id", s: crate::group::insert_user_keys_via_session_invite}
                          - put: {p: "/change_rank", s: crate::group::change_rank}
                          #_____________________________________________________________________________________________
                          # groups for join reqs
                          - group:
                              p: "/join_req"
                              gr:
                                - get: {p: "/:last_fetched_time", s: crate::group::get_join_req}
                                - put: {p: "/:join_user", s: crate::group::accept_join_req}
                                - delete: {p: "/:join_user", s: crate::group::reject_join_req}
                                - put: {p: "/session/:key_session_id", s: crate::group::insert_user_keys_via_session_join_req}
                          #_____________________________________________________________________________________________
                          # groups for key rotation
                          - group:
                              p: "/key_rotation"
                              gr:
                                - post: { p: "", s: crate::group::start_key_rotation }
                                - get: { p: "", s: crate::group::get_keys_for_update }
                                - put: { p: "/:key_id", s: crate::group::done_key_rotation_for_user }